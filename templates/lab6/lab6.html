{% extends "base.html" %}

{% block script %}
<script>
function getOfficeList() {
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "info",
        "id": Math.round(Math.random() * 1000),
    };
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        const ul = document.getElementById("office-list");
        ul.innerHTML = ""; // Очистка списка перед обновлением
        data.result.forEach(office => {
            const li = document.createElement("li");
            li.classList.add("office-item");

            const textSpan = document.createElement("span");
            textSpan.innerText = `Кабинет ${office.number}: ${office.tenant || "свободен"}`;
            li.appendChild(textSpan);

            const buttonsDiv = document.createElement("div");
            buttonsDiv.classList.add("buttons-container");

            // Кнопка "Зарезервировать"
            const bookingButton = document.createElement("button");
            bookingButton.innerText = "Зарезервировать";
            bookingButton.onclick = () => booking(office.number);
            buttonsDiv.appendChild(bookingButton);

            // Кнопка "Освободить"
            const cancelButton = document.createElement("button");
            cancelButton.innerText = "Освободить";
            cancelButton.onclick = () => {
                if (!office.tenant) {
                    alert("Кабинет уже свободен!");
                } else if (office.tenant !== "{{ session.get('login', '') }}") {
                    alert("Вы не можете снять аренду чужого офиса.");
                } else {
                    cancellation(office.number);
                }
            };
            buttonsDiv.appendChild(cancelButton);

            li.appendChild(buttonsDiv);
            ul.appendChild(li);
        });
    });
}

function booking(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "booking",
        "params": officeNumber,
        "id": Math.round(Math.random() * 1000),
    };
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error.message);
        } else {
            getOfficeList();
        }
    });
}

function cancellation(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "cancellation",
        "params": officeNumber,
        "id": Math.round(Math.random() * 1000),
    };
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error.message);
        } else {
            getOfficeList();
        }
    });
}

document.addEventListener("DOMContentLoaded", getOfficeList);
</script>
<style>
    ul#office-list {
        list-style-type: none;
        padding: 0;
    }

    ul#office-list li {
        margin-bottom: 15px; /* Отступ между строками */
        padding: 10px;
        display: flex;
        justify-content: space-between; /* Разделение текста и кнопок */
        align-items: center;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    ul#office-list li span {
        flex-grow: 1; /* Текст занимает всё доступное пространство */
    }

    ul#office-list li .buttons-container button {
        margin-left: 10px; /* Отступ между кнопками */
        padding: 5px 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    ul#office-list li .buttons-container button:nth-child(2) {
        background-color: #f44336; /* Красная кнопка "Освободить" */
    }

    ul#office-list li .buttons-container button:hover {
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block main %}
<h1>Список кабинетов</h1>
<ul id="office-list"></ul>
{% endblock %}
